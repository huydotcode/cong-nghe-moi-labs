<%- include('partials/header') %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üì¶ Danh s√°ch s·∫£n ph·∫©m</h1>
    <% if (user && user.role === 'admin') { %>
      <a href="/add" class="btn btn-success">+ Th√™m s·∫£n ph·∫©m</a>
    <% } %>
  </div>

  <!-- Search & Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <form action="/" method="GET" class="row g-3">
        <div class="col-md-3">
          <label for="search" class="form-label">T√¨m ki·∫øm</label>
          <input 
            type="text" 
            class="form-control" 
            id="search" 
            name="search" 
            placeholder="T√™n s·∫£n ph·∫©m..."
            value="<%= filters.search || '' %>"
          >
        </div>
        <div class="col-md-2">
          <label for="category" class="form-label">Danh m·ª•c</label>
          <select class="form-select" id="category" name="category">
            <option value="">T·∫•t c·∫£</option>
            <% categories.forEach(cat => { %>
              <option value="<%= cat.categoryId %>" <%= filters.category === cat.categoryId ? 'selected' : '' %>>
                <%= cat.name %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="col-md-2">
          <label for="minPrice" class="form-label">Gi√° t·ª´</label>
          <input 
            type="number" 
            class="form-control" 
            id="minPrice" 
            name="minPrice" 
            placeholder="0"
            value="<%= filters.minPrice || '' %>"
          >
        </div>
        <div class="col-md-2">
          <label for="maxPrice" class="form-label">Gi√° ƒë·∫øn</label>
          <input 
            type="number" 
            class="form-control" 
            id="maxPrice" 
            name="maxPrice" 
            placeholder="999999"
            value="<%= filters.maxPrice || '' %>"
          >
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button type="submit" class="btn btn-primary">L·ªçc</button>
          <a href="/" class="btn btn-outline-secondary">X√≥a b·ªô l·ªçc</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Products Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>·∫¢nh</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Danh m·ª•c</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Tr·∫°ng th√°i</th>
              <% if (user && user.role === 'admin') { %>
                <th class="text-center">Thao t√°c</th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% if (products && products.length > 0) { %>
              <% products.forEach(product => { %>
                <tr>
                  <td>
                    <% if (product.url_image) { %>
                      <img src="<%= product.url_image %>" alt="<%= product.name %>" width="60" height="60" style="object-fit: cover; border-radius: 8px;">
                    <% } else { %>
                      <div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border-radius: 8px;">
                        <span class="text-muted small">No img</span>
                      </div>
                    <% } %>
                  </td>
                  <td><strong><%= product.name %></strong></td>
                  <td>
                    <% 
                      const categoryName = categories.find(c => c.categoryId === product.categoryId)?.name;
                    %>
                    <%= categoryName || '-' %>
                  </td>
                  <td><%= parseFloat(product.price).toLocaleString() %> ƒë</td>
                  <td><%= product.quantity %></td>
                  <td>
                    <span class="badge bg-<%= product.inventoryStatus.class %>">
                      <%= product.inventoryStatus.label %>
                    </span>
                  </td>
                  <% if (user && user.role === 'admin') { %>
                    <td class="text-center">
                      <a href="/edit/<%= product.id %>" class="btn btn-sm btn-warning">S·ª≠a</a>
                      <form action="/delete/<%= product.id %>" method="POST" style="display:inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?');">
                        <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                      </form>
                    </td>
                  <% } %>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="<%= user && user.role === 'admin' ? 7 : 6 %>" class="text-center py-4">
                  Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.
                  <% if (user && user.role === 'admin') { %>
                    <a href="/add">Th√™m s·∫£n ph·∫©m m·ªõi</a>
                  <% } %>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination && pagination.totalPages > 1) { %>
        <nav aria-label="Product pagination">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&search=<%= filters.search || '' %>&category=<%= filters.category || '' %>&minPrice=<%= filters.minPrice || '' %>&maxPrice=<%= filters.maxPrice || '' %>">
                &laquo; Tr∆∞·ªõc
              </a>
            </li>
            
            <% for (let i = 1; i <= pagination.totalPages; i++) { %>
              <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&search=<%= filters.search || '' %>&category=<%= filters.category || '' %>&minPrice=<%= filters.minPrice || '' %>&maxPrice=<%= filters.maxPrice || '' %>">
                  <%= i %>
                </a>
              </li>
            <% } %>
            
            <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&search=<%= filters.search || '' %>&category=<%= filters.category || '' %>&minPrice=<%= filters.minPrice || '' %>&maxPrice=<%= filters.maxPrice || '' %>">
                Sau &raquo;
              </a>
            </li>
          </ul>
        </nav>
        <p class="text-center text-muted">
          Hi·ªÉn th·ªã <%= products.length %> / <%= pagination.totalItems %> s·∫£n ph·∫©m
        </p>
      <% } %>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
